# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## AI Warning

A lot of this content has been generated by AI using context to the codebase.
There may be some mistakes. YMMV. Please let me know if anything looks strange or off.

## [3.2.0] - 2025-12-13

### üÜï Added

-   **Multi-targeting support for .NET 10 LTS**: Both packages now target `net8.0`, `net9.0`, and `net10.0`
    -   `Blazor.WhyDidYouRender` v3.2.0 - Full .NET 10 LTS support with all .NET 10 package dependencies (10.0.1)
    -   `Blazor.WhyDidYouRender.Aspire` v3.2.0 - Now multi-targets all three frameworks
    -   Tests run against all three frameworks to ensure feature parity
    -   CI/CD pipeline updated to build and test with .NET 8, 9, and 10 SDKs

### üîß Changed

-   **SDK version**: Updated `global.json` to .NET 10.0.100 SDK
-   **Package versions**: Added .NET 10 package references with version 10.0.1 for all dependencies:
    -   Microsoft.AspNetCore.Components
    -   Microsoft.AspNetCore.Components.Web
    -   Microsoft.Extensions.DependencyInjection.Abstractions
    -   Microsoft.Extensions.Logging.Abstractions
    -   Microsoft.JSInterop
    -   Microsoft.Extensions.Hosting.Abstractions
    -   Microsoft.Extensions.Configuration.Binder
    -   Microsoft.Extensions.DependencyInjection
    -   System.Text.Encodings.Web

### üìö Documentation

-   Updated package release notes to reflect .NET 10 LTS support

---

## [3.1.0] - 2025-12-12

### üÜï Added

-   **Multi-targeting support for .NET 8 LTS**: The library now targets both `net8.0` and `net9.0`
    -   Users on the stable .NET 8 LTS runtime can now use the library seamlessly
    -   Conditional compilation handles .NET 9-specific APIs (e.g., `Lock` class)
    -   Framework-specific package references ensure correct dependency versions
    -   Tests run against both frameworks to ensure feature parity
-   **StateHasChanged Batching Detection**: Detect when Blazor batches multiple `StateHasChanged()` calls into a single render
    -   New `RenderEvent.StateHasChangedCallCount` property tracks how many `StateHasChanged` calls contributed to a render
    -   New `RenderEvent.IsBatchedRender` computed property returns `true` when count > 1
    -   `TrackedComponentBase` automatically tracks and reports batched calls
    -   Console output shows `üì¶ BATCHED: X StateHasChanged calls ‚Üí 1 render` for batched renders
    -   Browser console includes `stateHasChangedCalls` and `isBatchedRender` in log data
-   **OpenTelemetry Batching Metrics**: Full Aspire/OpenTelemetry integration for batching detection
    -   Activity tag `wdyrl.statehaschanged.call.count` tracks call count per render
    -   Activity tag `wdyrl.batched` (boolean) indicates batched renders
    -   Metrics tag `batched` added to render counter for filtering/grouping
    -   Both `AspireWhyDidYouRenderLogger` and `CompositeWhyDidYouRenderLogger` emit batching tags
-   **New Unit Tests**: 11 new tests for batching detection across OpenTelemetry and core tracking

### üîß Changed

-   **Improved thread synchronization**: Uses .NET 9 `Lock` class on .NET 9+, falls back to `object` locks on .NET 8
    -   `WasmSessionContextService`, `RenderFrequencyTracker`, `HostingEnvironmentDetector`, `LazyStateTrackingProvider`, `ServerErrorTracker`, and `WasmErrorTracker` all use conditional compilation for lock types

### üìö Documentation

-   Added comprehensive XML documentation to `CompositeWhyDidYouRenderLogger` for all public members

## [3.0.0] - 2025-12-02

### üîÑ Breaking Changes

-   **Removed legacy diagnostics interface and implementation**:
    -   `Blazor.WhyDidYouRender.Diagnostics.IErrorTracker` (sync version)
    -   `Diagnostics/ErrorTracker` and `Diagnostics/ErrorTrackerAdapter`
-   **Removed legacy tracking logger surface**:
    -   `Abstractions/ITrackingLogger`
    -   `Services/ServerTrackingLogger` and `Services/WasmTrackingLogger`
-   **Removed WebAssembly browser storage** (localStorage/sessionStorage) support
    -   Session IDs are now ephemeral (in-memory) only
    -   JSInterop retained only for browser console logging
    -   For durable correlation, use .NET Aspire/OpenTelemetry logs/traces instead

### üÜï Added

-   **New Unified Logging System** (`Blazor.WhyDidYouRender.Logging` namespace):
    -   `IWhyDidYouRenderLogger` - unified interface for all logging backends
    -   `ConsoleWhyDidYouRenderLogger` - safe fallback when MEL logger unavailable
    -   `ServerWhyDidYouRenderLogger` - server-side structured logging
    -   `WasmWhyDidYouRenderLogger` - browser console logging
    -   `CompositeWhyDidYouRenderLogger` - fan-out to multiple sinks
    -   `AspireWhyDidYouRenderLogger` - OTel/Aspire-aware logging with Activity correlation
-   **Aspire Extensions** (`AspireExtensions`): entry point for .NET Aspire/OpenTelemetry scenarios
-   **.NET Aspire DevHost Project**: Development host for testing with Aspire dashboard
-   **Comprehensive Test Suite**:
    -   `AspireOpenTelemetryTests.cs` - Activity/span creation, metrics emission, config flags
    -   `LoggerParityTests.cs` - Cross-backend consistency verification
    -   `ParameterChangeDetectorTests.cs`, `RenderTrackerServiceTests.cs`, `StateComparerTests.cs`
    -   `UnnecessaryRerenderDetectorTests.cs`

### üîí Security

-   **Fixed CVE-2021-26701**: Pinned `System.Text.Encodings.Web` to 9.0.2 to resolve critical Remote Code Execution vulnerability from transitive dependency 4.5.0

### üîß Changed

-   **Core architecture** now uses async `Abstractions.IErrorTracker` exclusively
-   **RenderTrackerService** relies only on unified logging (`Logging.IWhyDidYouRenderLogger`)
-   **ServiceCollectionExtensions** simplified; initializes error tracker on RenderTrackerService
-   **State tracking**: honor `[TrackState]` and `[IgnoreState]` precedence over heuristics
-   **Collection comparison**: improved to avoid false "unnecessary re-render" signals
-   **Frequent re-render detection**: tightened render frequency stats
-   **Samples** updated to use async error tracker methods
-   Pinned .NET SDK to **9.0.200** in `global.json`

### ‚ùå Removed

-   Sample `Diagnostics.razor` dashboard and all references; prefer Aspire/OTel and console-based diagnostics
-   `WasmStorageOptions` configuration class and related WASM storage functionality

### üìö Documentation

-   Added `docs/observability.md` for Aspire/OpenTelemetry verification and troubleshooting
-   Updated all documentation files for v3.0.0

### üîÑ Migration from 2.x

1. Remove any `config.WasmStorage*` configuration - no longer supported
2. If using legacy `ITrackingLogger`, migrate to `Logging.IWhyDidYouRenderLogger`
3. If using sync `Diagnostics.IErrorTracker`, migrate to async `Abstractions.IErrorTracker`
4. To enable Aspire/OTel, set in `AddWhyDidYouRender`:
    - `EnableOpenTelemetry = true`, `EnableOtelLogs = true`, `EnableOtelTraces = true`, `EnableOtelMetrics = true`
5. Ensure your host wires OTel with:
    - Tracing: `AddSource("Blazor.WhyDidYouRender")`
    - Metrics: `AddMeter("Blazor.WhyDidYouRender")`
    - OTLP exporter enabled (Aspire service defaults does this automatically)

## [2.1.1] - 2025-08-03

### üêõ Fixed

-   Incorrect handling on detecting state changes due to a duplicate call in a child method
    -   this led to "unnecessary re-render" being shown in the logs when the change was, in fact, necessary

## [2.1.0] - 2025-07-29

### üÜï Added

-   **Advanced State Tracking System**: Field-level change detection with automatic and manual tracking
-   **New Attributes**:
    -   `[TrackState]` - Mark fields/properties for explicit state tracking
    -   `[IgnoreState]` - Exclude fields from state tracking with optional reasons
    -   `[StateTrackingOptions]` - Component-level configuration overrides
-   **Enhanced Configuration Options**:
    -   `EnableStateTracking` - Enable/disable field-level state change tracking
    -   `AutoTrackSimpleTypes` - Auto-track simple value types (string, int, bool, etc.)
    -   `MaxTrackedFieldsPerComponent` - Limit fields per component for performance
    -   `LogDetailedStateChanges` - Log detailed before/after values for state changes
    -   `TrackInheritedFields` - Track fields inherited from base classes
    -   `MaxStateComparisonDepth` - Maximum depth for object comparison
    -   `EnableCollectionContentTracking` - Track changes within collection contents
    -   `StateSnapshotCleanupIntervalMinutes` - Interval for cleaning up old state snapshots
    -   `MaxStateSnapshotAgeMinutes` - Maximum age for state snapshots before cleanup
    -   `MaxTrackedComponents` - Maximum number of components to track simultaneously
    -   `ExcludeFromStateTracking` - Exclude specific component types from state tracking
-   **New Data Models**:
    -   `StateChange` - Represents a change in component state
    -   `StateSnapshot` - Captures component state at a specific point in time
    -   Enhanced `RenderEvent` with `StateChanges` property
-   **Performance Features**:
    -   Thread-safe state tracking for Blazor Server scenarios
    -   Configurable memory management and cleanup
    -   Performance optimization options for high-load scenarios
-   **Component-Level Configuration**: Fine-grained control over state tracking per component
-   **Enhanced Console Output**: State changes now included in render tracking logs

### üîß Changed

-   **License**: Changed from GNU GPL v3 to GNU LGPL v3 to allow closed source projects to use the library
-   **Documentation**: Comprehensive updates across all documentation files
-   **Configuration**: Extended `WhyDidYouRenderConfig` with state tracking options
-   **Examples**: Added state tracking examples and configuration patterns

### üöÄ Performance

-   Optimized state comparison algorithms with configurable depth limits
-   Implemented efficient cleanup mechanisms for state snapshots
-   Added performance monitoring for state tracking operations
-   Thread-safe implementation for concurrent access scenarios

## [2.0.0] - 2025-07-20

### üÜï Added

-   **Cross-Platform Support**: Full support for Blazor WebAssembly alongside existing Server/SSR support
-   **Automatic Environment Detection**: Automatically detects and adapts to hosting environment
-   **Browser Console Logging**: Rich logging output in browser developer tools
-   **WASM Storage Support**: localStorage/sessionStorage integration for WebAssembly environments
-   **New Configuration Options**:
    -   `AutoDetectEnvironment` - Automatically detect hosting model
    -   `ForceHostingModel` - Override automatic environment detection
    -   `Output = TrackingOutput.Both` - Output to both server and browser console
    -   `WasmStorageEnabled` - Enable browser storage for WASM environments
    -   `WasmStorageOptions` - Configure WASM storage behavior
-   **Environment-Specific Services**:
    -   `ServerSessionContextService` / `WasmSessionContextService`
    -   `ServerTrackingLogger` / `WasmTrackingLogger`
    -   `ServerErrorTracker` / `WasmErrorTracker`
-   **New Initialization Methods**:
    -   `InitializeServerAsync()` - For Blazor Server environments
    -   `InitializeWasmAsync()` - For WebAssembly environments
    -   `InitializeSSRServices()` - For SSR environments

### üîß Changed

-   **Architecture**: Redesigned with cross-platform abstraction layer
-   **Service Registration**: Enhanced service collection extensions for multi-platform support
-   **Session Management**: Platform-specific session handling (HttpContext vs Browser Storage)
-   **Error Tracking**: Environment-aware error tracking and reporting

### ‚ùå Removed

-   (none)

### üìö Documentation

-   Clarified that the legacy diagnostics endpoint was already removed prior to v1.0; migration notes updated accordingly

### üîÑ Migration Required

-   Add explicit initialization calls after service registration
-   Remove diagnostics endpoint configuration and middleware
-   Update output configuration to use new `TrackingOutput.Both` option

## [1.0.0] - 2025-07-19

### üéâ Initial Release

-   **Core Render Tracking**: Monitor when and why Blazor components re-render
-   **Parameter Change Detection**: Identify which parameter changes trigger re-renders
-   **Performance Metrics**: Track render duration and frequency
-   **Unnecessary Render Detection**: Find components that re-render without actual changes
-   **Blazor Server Support**: Full support for Blazor Server applications
-   **SSR Support**: Server-Side Rendering compatibility
-   **Component Base Class**: `TrackedComponentBase` for easy integration
-   **Configuration System**: Flexible configuration options via `WhyDidYouRenderConfig`
-   **Console Logging**: Detailed render tracking output
-   **Session Management**: HttpContext-based session tracking
-   **Error Diagnostics**: Built-in error tracking and diagnostics endpoint

### üîß Configuration Options

-   `Enabled` - Enable/disable tracking
-   `Verbosity` - Control logging detail level
-   `Output` - Configure output destinations
-   `TrackParameterChanges` - Enable parameter change detection
-   `TrackPerformance` - Enable performance tracking
-   `IncludeSessionInfo` - Include session information in logs

---

## Legend

-   üÜï **Added** - New features
-   üîß **Changed** - Changes in existing functionality
-   ‚ùå **Removed** - Removed features
-   üêõ **Fixed** - Bug fixes
-   üöÄ **Performance** - Performance improvements
-   üîÑ **Migration Required** - Breaking changes requiring user action
-   üéâ **Major Milestone** - Significant releases
