@page "/state-tracking"
@rendermode InteractiveServer
@inherits TrackedComponentBase
@using Blazor.WhyDidYouRender.Attributes
@attribute [StateTrackingOptions(EnableStateTracking = true, LogStateChanges = true)]

<PageTitle>State Tracking Demo</PageTitle>

<h1>State Tracking Demo</h1>

<div class="alert alert-info">
    <p>This page demonstrates state tracking with the session timing fix. All tracked fields should log changes to the console.</p>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Simple State Fields</h5>
            </div>
            <div class="card-body">
                <p><strong>Counter:</strong> @counter</p>
                <p><strong>Message:</strong> @message</p>
                <p><strong>Is Active:</strong> @isActive</p>
                <p><strong>Last Updated:</strong> @lastUpdated.ToString("HH:mm:ss")</p>
                
                <button class="btn btn-primary me-2" @onclick="IncrementCounter">Increment</button>
                <button class="btn btn-secondary me-2" @onclick="ChangeMessage">Change Message</button>
                <button class="btn btn-info me-2" @onclick="ToggleActive">Toggle Active</button>
                <button class="btn btn-warning" @onclick="UpdateTime">Update Time</button>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Complex Object State</h5>
            </div>
            <div class="card-body">
                <p><strong>User Name:</strong> @user?.Name</p>
                <p><strong>User Email:</strong> @user?.Email</p>
                <p><strong>User Age:</strong> @user?.Age</p>
                <p><strong>Settings Count:</strong> @user?.Settings?.Count</p>
                
                <button class="btn btn-primary me-2" @onclick="UpdateUserName">Update Name</button>
                <button class="btn btn-secondary me-2" @onclick="UpdateUserAge">Update Age</button>
                <button class="btn btn-info me-2" @onclick="AddSetting">Add Setting</button>
                <button class="btn btn-danger" @onclick="ReplaceUser">Replace User</button>
            </div>
        </div>
    </div>
</div>

<div class="row mt-3">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Collection State</h5>
            </div>
            <div class="card-body">
                <p><strong>Items Count:</strong> @items.Count</p>
                <ul>
                    @foreach (var item in items.Take(5))
                    {
                        <li>@item</li>
                    }
                    @if (items.Count > 5)
                    {
                        <li><em>... and @(items.Count - 5) more items</em></li>
                    }
                </ul>
                
                <button class="btn btn-success me-2" @onclick="AddItem">Add Item</button>
                <button class="btn btn-warning me-2" @onclick="ModifyFirstItem">Modify First</button>
                <button class="btn btn-danger" @onclick="ClearItems">Clear All</button>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Ignored Fields</h5>
            </div>
            <div class="card-body">
                <p><strong>Performance Counter:</strong> @performanceCounter</p>
                <p><strong>Debug Info:</strong> @debugInfo</p>
                <p><strong>Render Count:</strong> @renderCount</p>
                
                <button class="btn btn-outline-secondary me-2" @onclick="UpdatePerformanceCounter">Update Performance</button>
                <button class="btn btn-outline-info me-2" @onclick="UpdateDebugInfo">Update Debug</button>
                <button class="btn btn-outline-warning" @onclick="ForceRender">Force Render</button>
            </div>
        </div>
    </div>
</div>

<div class="row mt-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>State Tracking Information</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">
                    This component demonstrates various state tracking scenarios:
                </p>
                <ul class="text-muted">
                    <li><strong>Tracked Fields:</strong> counter, message, isActive, lastUpdated, user, items</li>
                    <li><strong>Ignored Fields:</strong> performanceCounter, debugInfo, renderCount</li>
                    <li><strong>Custom Comparison:</strong> user object uses custom comparison logic</li>
                    <li><strong>Collection Tracking:</strong> items list tracks content changes</li>
                </ul>
                <p class="text-info">
                    Check the browser console to see state tracking with session information (no errors)!
                </p>
            </div>
        </div>
    </div>
</div>

@code {
    // Simple tracked fields
    [TrackState]
    private int counter = 0;

    [TrackState]
    private string message = "Initial message";

    [TrackState]
    private bool isActive = false;

    [TrackState]
    private DateTime lastUpdated = DateTime.Now;

    // Complex object with custom comparison
    [TrackState(UseCustomComparer = true, MaxComparisonDepth = 3)]
    private UserData? user = new UserData 
    { 
        Name = "John Doe", 
        Email = "john@example.com", 
        Age = 30,
        Settings = new Dictionary<string, object> { { "theme", "dark" }, { "language", "en" } }
    };

    // Collection with content tracking
    [TrackState(TrackCollectionContents = true, MaxComparisonDepth = 2)]
    private List<string> items = new List<string> { "Item 1", "Item 2", "Item 3" };

    // Ignored fields (won't trigger state change detection)
    [IgnoreState("Performance counter - changes frequently")]
    private long performanceCounter = 0;

    [IgnoreState("Debug information - not relevant for rendering")]
    private string debugInfo = "Debug: Component initialized";

    [IgnoreState("Internal render tracking")]
    private int renderCount = 0;

    protected override void OnAfterRender(bool firstRender)
    {
        base.OnAfterRender(firstRender);
        renderCount++;
    }

    // Simple field operations
    private void IncrementCounter()
    {
        counter++;
        lastUpdated = DateTime.Now;
    }

    private void ChangeMessage()
    {
        var messages = new[] { "Hello World!", "State tracking works!", "Blazor is awesome!", "Testing state changes" };
        message = messages[Random.Shared.Next(messages.Length)];
        lastUpdated = DateTime.Now;
    }

    private void ToggleActive()
    {
        isActive = !isActive;
        lastUpdated = DateTime.Now;
    }

    private void UpdateTime()
    {
        lastUpdated = DateTime.Now;
    }

    // Complex object operations
    private void UpdateUserName()
    {
        if (user != null)
        {
            var names = new[] { "John Doe", "Jane Smith", "Bob Johnson", "Alice Brown" };
            user.Name = names[Random.Shared.Next(names.Length)];
        }
    }

    private void UpdateUserAge()
    {
        if (user != null)
        {
            user.Age = Random.Shared.Next(18, 80);
        }
    }

    private void AddSetting()
    {
        if (user?.Settings != null)
        {
            var key = $"setting_{Random.Shared.Next(1000)}";
            var value = $"value_{Random.Shared.Next(1000)}";
            user.Settings[key] = value;
        }
    }

    private void ReplaceUser()
    {
        user = new UserData
        {
            Name = "New User",
            Email = "new@example.com",
            Age = 25,
            Settings = new Dictionary<string, object> { { "theme", "light" } }
        };
    }

    // Collection operations
    private void AddItem()
    {
        var newItem = $"Item {items.Count + 1} - {DateTime.Now:HH:mm:ss}";
        items.Add(newItem);
    }

    private void ModifyFirstItem()
    {
        if (items.Count > 0)
        {
            items[0] = $"Modified Item - {DateTime.Now:HH:mm:ss}";
        }
    }

    private void ClearItems()
    {
        items.Clear();
    }

    // Ignored field operations (should not trigger state change detection)
    private void UpdatePerformanceCounter()
    {
        performanceCounter = Environment.TickCount64;
    }

    private void UpdateDebugInfo()
    {
        debugInfo = $"Debug: Updated at {DateTime.Now:HH:mm:ss.fff}";
    }

    private void ForceRender()
    {
        StateHasChanged();
    }

    public class UserData
    {
        public string Name { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public int Age { get; set; }
        public Dictionary<string, object> Settings { get; set; } = new();
    }
}
